#!/usr/bin/env node
import{existsSync as C,mkdirSync as $,createWriteStream as x,chmodSync as y,unlinkSync as c,createReadStream as _}from"fs";import{dirname as U,join as m}from"path";import{fileURLToPath as E}from"url";import{createHash as I}from"crypto";import{extract as S}from"tar";import g from"https";import h from"os";var T=E(import.meta.url),F=U(T),i="0.2.1",l=m(F,"..",".tokenuse","bin");function f(){let e=h.platform(),o=h.arch(),r=e==="darwin"?"darwin":e==="linux"?"linux":(()=>{throw new Error(`Unsupported: ${e}`)})(),t=o==="x64"||o==="amd64"?"amd64":o==="arm64"||o==="aarch64"?"arm64":(()=>{throw new Error(`Unsupported: ${o}`)})();return{os:r,arch:t,platform:`${r}_${t}`}}function b(e){return`https://github.com/tokenuse/tokenuse/releases/download/v${e}/tokenuse_${e}_${f().platform}.tar.gz`}function v(e){return`https://github.com/tokenuse/tokenuse/releases/download/v${e}/checksums.txt`}function H(e){return`tokenuse_${e}_${f().platform}.tar.gz`}async function L(e){return new Promise((o,r)=>{let t=I("sha256"),n=_(e);n.on("data",a=>t.update(a)),n.on("end",()=>o(t.digest("hex"))),n.on("error",r)})}function R(e){let o=new Map;for(let r of e.trim().split(`
`)){let[t,n]=r.trim().split(/\s+/);t&&n&&o.set(n,t)}return o}async function k(e,o){return new Promise((r,t)=>{let n=x(o);g.get(e,s=>{if(s.statusCode===301||s.statusCode===302){n.close(),c(o),k(s.headers.location,o).then(r).catch(t);return}if(s.statusCode!==200){n.close(),c(o),t(new Error(`Failed to download: HTTP ${s.statusCode}`));return}s.pipe(n),n.on("finish",()=>{n.close(),r()})}).on("error",s=>{n.close(),c(o),t(s)}),n.on("error",s=>{n.close(),c(o),t(s)})})}async function w(e){return new Promise((o,r)=>{g.get(e,t=>{if(t.statusCode===301||t.statusCode===302){w(t.headers.location).then(o).catch(r);return}if(t.statusCode!==200){r(new Error(`Failed to fetch: HTTP ${t.statusCode}`));return}let n="";t.on("data",a=>n+=a),t.on("end",()=>o(n)),t.on("error",r)}).on("error",r)})}async function N(){let e=f();console.log(`Installing TokenUse CLI v${i} for ${e.platform}...`),$(l,{recursive:!0});let o=m(l,"tokenuse.tar.gz"),r=b(i);console.log(`Downloading from ${r}...`),await k(r,o),console.log("Verifying checksum...");try{let n=v(i),a=await w(n),s=R(a),p=H(i),u=s.get(p);if(u){let d=await L(o);if(d.toLowerCase()!==u.toLowerCase())throw c(o),new Error(`Checksum verification failed!
Expected: ${u}
Actual: ${d}`);console.log("Checksum verified.")}else console.log("Warning: Checksum not found, skipping verification.")}catch(n){console.log(`Warning: Could not verify checksum: ${n.message}`)}console.log("Extracting..."),await S({file:o,cwd:l,strip:1});let t=m(l,"tokenuse");C(t)&&y(t,493),c(o),console.log("TokenUse CLI installed successfully!"),console.log(""),console.log("Get started:"),console.log("  tokenuse          # Start tracking (auto signs in)"),console.log("  tokenuse status   # Check tracking status")}N().catch(e=>{console.error(`Installation failed: ${e.message}`),process.exit(1)});
